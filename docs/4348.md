# æˆ‘æ˜¯å¦‚ä½•ç”¨ Python å’Œ Twilio å…¥ä¾µæˆ‘å¤§å­¦çš„æ³¨å†Œç³»ç»Ÿçš„

> åŸæ–‡:[https://www . twilio . com/blog/2017/06/hacked-my-universitys-registration-system-python-twilio . htmlï¼ŸUTM _ source = Wanqu . co&UTM _ campaign = Wanqu+Daily&UTM _ medium = website](https://www.twilio.com/blog/2017/06/hacked-my-universitys-registration-system-python-twilio.html?utm_source=wanqu.co&utm_campaign=Wanqu+Daily&utm_medium=website)



å¤§å­¦ç”ŸçŸ¥é“è¯•å›¾æ³¨å†Œä¸€é—¨è¯¾å´å‘ç°å·²ç»æ»¡å‘˜çš„ç—›è‹¦ã€‚åœ¨æˆ‘çš„å¤§å­¦é‡Œï¼Œå¤§å¤šæ•°è¯¾ç¨‹ç”šè‡³æ²¡æœ‰ç­‰å€™åå•ç³»ç»Ÿã€‚æˆ‘ä»¬ä¸å¾—ä¸æ±‚åŠ©äºä¸€å¤©å¤šæ¬¡ç™»å½•å¹¶æ£€æŸ¥ç½‘ç«™ã€‚è¿™çœ‹èµ·æ¥åƒæ˜¯è®¡ç®—æœºèƒ½åšçš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘å¼€å§‹ç”¨ä¸€ç‚¹ Python å’Œ [Twilio API](https://www.twilio.com/docs/api/rest) æ¥è‡ªåŠ¨åŒ–å®ƒã€‚

## å…¥é—¨æŒ‡å—

å› ä¸ºå¤§å­¦çš„è¯¾ç¨‹æ³¨å†Œç³»ç»Ÿæ˜¯åœ¨å¯†ç ç™»å½•ä¹‹åï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æˆ‘å»ºç«‹çš„çš„[ç®€åŒ–ç½‘ç«™ã€‚ä¸ºäº†è¿™ä¸ªæ¼”ç¤ºçš„ç›®çš„ï¼Œå®ƒæ¯åˆ†é’Ÿåœ¨ CS 101 ä¸­æ²¡æœ‰ç©ºåº§ä½å’Œæœ‰ä¸€ä¸ªç©ºåº§ä½ä¹‹é—´äº¤æ›¿ã€‚](http://courses.project.samueltaylor.org/)

æˆ‘ä»¬å°†ä½¿ç”¨ä¸€äº›åº“æ¥å¸®åŠ©æˆ‘ä»¬å®Œæˆè¿™ä¸ªé¡¹ç›®ã€‚å‡è®¾æ‚¨å·²ç»å®‰è£…äº†[pip](https://pip.pypa.io/en/stable/installing/)ï¼Œç»§ç»­è¿è¡Œä¸‹é¢çš„`pip`å‘½ä»¤æ¥å®‰è£…å®ƒä»¬:

```
pip install requests==2.17.3 beautifulsoup4==4.6.0 redis==2.10.5 twilio==6.3.0 Flask==0.12.2 
```

éšç€æˆ‘ä»¬çš„æ·±å…¥ï¼Œæˆ‘ä»¬å°†æ·±å…¥ä½¿ç”¨å…¶ä¸­çš„æ¯ä¸€ä¸ªåº“ã€‚

## åˆ®ç™»è®°åˆ¶åº¦

æˆ‘ä»¬éœ€è¦ç¼–å†™ä¸€ä¸ªç¨‹åºæ¥ç¡®å®šç»™å®šè¯¾ç¨‹ä¸­æ˜¯å¦æœ‰åº§ä½ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨ä¸€ç§å«åšç½‘ç»œæŠ“å–çš„æŠ€æœ¯ï¼Œåœ¨è¿™ç§æŠ€æœ¯ä¸­ï¼Œæˆ‘ä»¬ä»äº’è”ç½‘ä¸Šä¸‹è½½ä¸€ä¸ªé¡µé¢å¹¶æ‰¾åˆ°é‡è¦çš„éƒ¨åˆ†ã€‚ä¸¤ä¸ªæµè¡Œçš„åº“ä½¿è¿™å˜å¾—å®¹æ˜“ï¼Œå®ƒä»¬æ˜¯ [Requests](http://docs.python-requests.org/en/master/) å’Œ [BeautifulSoup](https://www.crummy.com/software/BeautifulSoup/) ã€‚è¯·æ±‚ä½¿è·å–ç½‘é¡µå˜å¾—å®¹æ˜“ï¼ŒBeautifulSoup å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°å¯¹æˆ‘ä»¬æ¥è¯´é‡è¦çš„ç½‘é¡µéƒ¨åˆ†ã€‚

```
# scraper.py
import requests
from bs4 import BeautifulSoup

URL = 'http://courses.project.samueltaylor.org/'
COURSE_NUM_NDX = 0
SEATS_NDX = 1

def get_open_seats():
    r = requests.get(URL)
    soup = BeautifulSoup(r.text, 'html.parser')
    courses = {}

    for row in soup.find_all('tr'):
        cols = [e.text for e in row.find_all('td')]
        if cols:
            courses[cols[COURSE_NUM_NDX]] = int(cols[SEATS_NDX])
    return courses 
```

è¿™é‡Œçš„è‚‰åœ¨`get_open_seats`å‡½æ•°é‡Œã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ requests.get ä¸‹è½½é¡µé¢çš„ HTML æºä»£ç ï¼Œç„¶åç”¨ BeautifulSoup è§£æå®ƒã€‚æˆ‘ä»¬ä½¿ç”¨`find_all('tr')`è·å–è¡¨ä¸­çš„æ‰€æœ‰è¡Œï¼Œæ›´æ–°è¯¾ç¨‹å­—å…¸ä»¥æŒ‡ç¤ºç»™å®šè¯¾ç¨‹ä¸­å¯ç”¨çš„åº§ä½æ•°ã€‚find_all å¯ä»¥æ¯”è¿™ä¸ªç®€å•çš„ä¾‹å­ç”¨å¾—æ›´å¼ºå¤§ï¼Œæ‰€ä»¥å¦‚æœä½ æœ‰å…´è¶£äº†è§£æ›´å¤šçš„è¯ï¼Œå¯ä»¥æŸ¥çœ‹ä¸€ä¸‹[æ–‡æ¡£](https://www.crummy.com/software/BeautifulSoup/bs4/doc/#searching-the-tree)ã€‚æœ€åï¼Œæˆ‘ä»¬è¿”å›è¯¾ç¨‹å­—å…¸ï¼Œä»¥ä¾¿æˆ‘ä»¬çš„ç¨‹åºå¯ä»¥æŸ¥æ‰¾ç»™å®šè¯¾ç¨‹ä¸­æœ‰å¤šå°‘åº§ä½(å³`courses['CS 101']`æ˜¯ CS 101 ä¸­å¯ç”¨çš„åº§ä½æ•°)ã€‚

ä¸‡å²ï¼Œç°åœ¨æˆ‘ä»¬å¯ä»¥ç¡®å®šä¸€ä¸ªè¯¾ç¨‹æ˜¯å¦æœ‰ç©ºä½ã€‚æµ‹è¯•è¿™ä¸ªå‡½æ•°çš„ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•æ˜¯åœ¨ Python è§£é‡Šå™¨ä¸­ã€‚å°†è¿™æ®µä»£ç ä¿å­˜åˆ°ä¸€ä¸ªåä¸º scraper.py çš„æ–‡ä»¶ä¸­ï¼Œç„¶åè¿è¡Œè„šæœ¬å¹¶è¿›å…¥äº¤äº’æ¨¡å¼ï¼Œçœ‹çœ‹è¿™ä¸ªå‡½æ•°åšäº†ä»€ä¹ˆ:

```
$ python -i scraper.py
>>> get_open_seats()
{'CS 101': 1, 'CS 201': 0} 
```

è™½ç„¶è¿™å¾ˆå¥½ï¼Œä½†æˆ‘ä»¬è¿˜æ²¡æœ‰æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼›æˆ‘ä»¬ä»ç„¶éœ€è¦æŸç§æ–¹æ³•æ¥é€šçŸ¥ç”¨æˆ·ä½•æ—¶æœ‰åº§ä½ç©ºå‡ºæ¥ã€‚[æœ±å©·çŸ­ä¿¡](https://www.twilio.com/docs/api/rest/sending-messages)æ¥æ•‘æ´äº†ï¼

## é€šè¿‡çŸ­ä¿¡è·å–æ›´æ–°

å½“æ„å»ºç”¨æˆ·ç•Œé¢æ—¶ï¼Œæˆ‘ä»¬å¸Œæœ›ç®€å•çš„äº‹æƒ…å˜å¾—ç®€å•ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨æˆ·å¸Œæœ›åœ¨è¯¾ç¨‹çš„åº§ä½ç©ºå‡ºæ¥æ—¶å¾—åˆ°é€šçŸ¥ã€‚ä»–ä»¬å‘æˆ‘ä»¬ä¼ è¾¾è¿™ä¸€æ„å›¾çš„æœ€ç®€å•æ–¹å¼æ˜¯åˆ†äº«è¯¾ç¨‹ç¼–å·ã€‚è®©æˆ‘ä»¬é€šè¿‡è®¾ç½®å’Œå¤„ç† webhook æ¥å®ç°è®¢é˜…åŠŸèƒ½ã€‚æˆ‘é€‰æ‹©ä½¿ç”¨ [Redis](https://redis.io/) (ä¸€ä¸ªæä¾›å¯ä»¥ä»å¤šä¸ªè¿›ç¨‹è®¿é—®çš„æ•°æ®ç»“æ„çš„å·¥å…·)æ¥å­˜å‚¨è®¢é˜…ã€‚

```
# sms_handler.py
from flask import Flask, request
import redis

twilio_account_sid = 'ACXXXXX'
redis_client = redis.StrictRedis(host='localhost', port=6379, db=0)
app = Flask(__name__)

@app.route('/sms', methods=['POST'])
def handle_sms():
    user = request.form['From']
    course = request.form['Body'].strip().upper()

    redis_client.sadd(course, user.encode('utf-8'))

if __name__ == '__main__':
    app.run(debug=True) 
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ä¸€ä¸ªåä¸º [Flask](https://www.fullstackpython.com/flask.html) çš„ Python æ¡†æ¶æ¥åˆ›å»ºä¸€ä¸ªå¤„ç† SMS æ¶ˆæ¯çš„å°æœåŠ¡ã€‚åœ¨ä¸€äº›åˆå§‹è®¾ç½®ä¹‹åï¼Œæˆ‘ä»¬æŒ‡å‡ºå¯¹`/sms`ç«¯ç‚¹çš„è¯·æ±‚åº”è¯¥ç”±`handle_sms`å‡½æ•°æ¥å¤„ç†ã€‚åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œæˆ‘ä»¬è·å–ç”¨æˆ·çš„ç”µè¯å·ç å’Œä»–ä»¬æ­£åœ¨å¯»æ‰¾çš„è¯¾ç¨‹ï¼Œå¹¶å°†å®ƒä»¬å­˜å‚¨åœ¨ä»¥è¯¾ç¨‹å‘½åçš„é›†åˆä¸­ã€‚

å°±è·å–è®¢é˜…è€Œè¨€ï¼Œè¿™å¾ˆå¥½ï¼Œä½†æ˜¯è¿™æ˜¯ä¸€ä¸ªä»¤äººæ²®ä¸§çš„ç”¨æˆ·ç•Œé¢ï¼Œå› ä¸ºå®ƒæ²¡æœ‰å‘ç”¨æˆ·æä¾›ä»»ä½•åé¦ˆã€‚æˆ‘ä»¬æƒ³å›åˆ°ç”¨æˆ·èº«è¾¹ï¼Œå‘Šè¯‰ä»–ä»¬æˆ‘ä»¬æ˜¯å¦èƒ½å¤Ÿå°½å¿«æ»¡è¶³ä»–ä»¬çš„è¦æ±‚ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†æä¾›ä¸€ä¸ª [TwiML å“åº”](https://www.twilio.com/docs/api/twiml/sms/your_response)ã€‚ä¸‹é¢çªå‡ºæ˜¾ç¤ºäº†ä¸ºæ­¤æ‰€éœ€çš„é™„åŠ è¡Œã€‚

```
# sms_handler.py
from flask import Flask, request
import redis
from twilio.twiml.messaging_response import MessagingResponse

twilio_account_sid = 'ACXXXXX'
my_number = '+1XXXXXXXXXX'
valid_courses = {'CS 101', 'CS 201'}

redis_client = redis.StrictRedis(host='localhost', port=6379, db=0)
app = Flask(__name__)

def respond(user, body):
    response = MessagingResponse()
    response.message(body=body)
    return str(response)

@app.route('/sms', methods=['POST'])
def handle_sms():
    user = request.form['From']
    course = request.form['Body'].strip().upper()
    if course not in valid_courses:
        return respond(user, body="Hm, that doesn't look like a valid course. Try something like 'CS 101'.")

    redis_client.sadd(course, user.encode('utf-8'))
        return respond(user, body=f"Sweet action. We'll let you know when there are seats available in {course}")

if __name__ == '__main__':
    app.run(debug=True) 
```

æˆ‘ä»¬å¯¹ä¸Šé¢çš„ä»£ç åšäº†ä¸¤ä¸ªä¸»è¦çš„ä¿®æ”¹ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬éªŒè¯ç”¨æˆ·æ­£åœ¨è¯·æ±‚ä¸€ä¸ªæœ‰æ•ˆçš„è¯¾ç¨‹ã€‚ç¬¬äºŒï¼Œå½“ç”¨æˆ·è¦æ±‚æ›´æ–°æ—¶ï¼Œæˆ‘ä»¬ä¼šä½œå‡ºå›åº”ã€‚åœ¨ respond å‡½æ•°ä¸­ï¼Œæˆ‘ä»¬ç”¨ç»™å®šçš„æ¶ˆæ¯ä¸ºç»™å®šçš„æ•°å­—æ„é€ ä¸€ä¸ª TwiML å“åº”ã€‚

ç¡®ä¿[å®‰è£… Redis](https://www.fullstackpython.com/blog/install-redis-use-python-3-ubuntu-1604.html) å¹¶ç”¨`redis-server`å‘½ä»¤å¯åŠ¨ã€‚å°†ä¸Šè¿°ä»£ç ä¿å­˜åˆ°ä¸€ä¸ªåä¸º`sms_handler.py`çš„æ–‡ä»¶ä¸­ï¼Œç„¶åè¿è¡Œ`python sms_handler.py`ã€‚

ä¸å¯å¦è®¤ï¼Œè¿™é‡Œçš„å›å¤ä¿¡æ¯æœ‰ç‚¹å‚»ï¼Œä½†æˆ‘å¾ˆæƒŠè®¶åœ°çœ‹åˆ°ç”¨æˆ·æœ‰å¤šå–œæ¬¢å®ƒä»¬ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œä¸ªäººæ¥è§¦å¯ä»¥å¸¦æ¥æ›´å¥½çš„ç”¨æˆ·ä½“éªŒã€‚

è®©æˆ‘ä»¬æ‰©å±•æˆ‘ä»¬ä¹‹å‰çš„æŠ“å–è„šæœ¬ï¼Œå®é™…é€šçŸ¥é‚£äº›äººï¼Œç°åœ¨æˆ‘ä»¬çŸ¥é“è°æƒ³è¦å¾—åˆ°è¯¾ç¨‹å¼€æ”¾çš„é€šçŸ¥ã€‚

```
# scraper.py
from twilio.rest import Client

client = Client(twilio_account_sid, token)
redis_client = redis.StrictRedis(host='localhost', port=6379, db=0)

def message(recipient, body):
    message = client.messages.create(to=recipient, from_=my_number, body=body)

if __name__ == '__main__':
    courses = get_open_seats()
    for course, seats in courses.items():
        if seats == 0:
            continue

        to_notify = redis_client.smembers(course)
        for user in to_notify:
            message(user.decode('utf-8'), 
                    body=f"Good news! Spots opened up in {course}. " + \
                          "We'll stop bugging you about this one now.")
            redis_client.srem(course, user) 
```

æˆ‘ä»¬å¯ä»¥ä¸€æ¬¡æ€§è¿è¡Œè¿™ä¸ªåˆ®åˆ€ï¼Œé€šè¿‡è¿è¡Œ`python scraper.py`æ¥æµ‹è¯•å®ƒã€‚

## ç”¨ Cron ä½œä¸šè·Ÿè¸ªè¯¾ç¨‹

è™½ç„¶å°†æ£€æŸ¥è¯¾ç¨‹æ³¨å†Œç«™ç‚¹çš„è¿‡ç¨‹ç®€åŒ–ä¸ºä¸€ä¸ªè„šæœ¬å¾ˆå¥½ï¼Œä½†æˆ‘ä»¬å¸Œæœ›è„šæœ¬æ¯éš”å‡ åˆ†é’Ÿè‡ªåŠ¨è¿è¡Œä¸€æ¬¡ã€‚ä½¿ç”¨ [Cron](https://en.wikipedia.org/wiki/Cron) å¯ä»¥è½»æ¾è§£å†³è¿™ä¸ªé—®é¢˜ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œ`crontab -e`å¹¶æ·»åŠ ä»¥ä¸‹è¡Œæ¥æ·»åŠ æ¯ä¸‰åˆ†é’Ÿè¿è¡Œä¸€æ¬¡çš„ä»»åŠ¡:

```
*/3 * * * * /path/to/scraper.py 
```

æœ‰äº†è¿™äº›ä»£ç ï¼ŒCron å®ˆæŠ¤è¿›ç¨‹å°†æ¯ä¸‰åˆ†é’Ÿè¿è¡Œä¸€æ¬¡æˆ‘ä»¬çš„ scraperã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿è¡Œ`crontab -l`çœ‹åˆ°é¢„å®šçš„ä»»åŠ¡ã€‚å°±æ˜¯è¿™æ ·ï¼æˆ‘ä»¬å¯ä»¥è®¢é˜…ä¸€ä¸ªè¯¾ç¨‹çš„æ›´æ–°ï¼Œå›åˆ°ç”Ÿæ´»ä¸­é‡è¦çš„äº‹æƒ…ã€‚ä½œä¸ºä¸€ä¸ªæœ‰è¶£çš„é™„å¸¦å¥½å¤„ï¼Œå½“ä½ è®©ä½ çš„æœ‹å‹ä»¬å‚åŠ é‚£ä¸ªæ‰“åŒ…çš„â€œä¼‘æ¯å’Œæ”¾æ¾â€è¯¾ç¨‹æ—¶ï¼Œä»–ä»¬ä¼šéå¸¸æ„Ÿæ¿€ä½ çš„ã€‚è™½ç„¶è¿›å…¥æˆ‘æƒ³è¦çš„ç­çº§æ˜¯å¯¹å·¥ä½œçš„å¤§é‡å¥–åŠ±ï¼Œä½†å®ƒæœ€ç»ˆä¹Ÿå¸®åŠ©äº†å¤§çº¦åå‡ ä¸ªäººè·å¾—äº†ä»–ä»¬ç†æƒ³çš„æ—¶é—´è¡¨ã€‚
![](../Images/b3083668b2537c08e6f1ac298df62b0f.png)

ä½¿ç”¨è¿™ç¯‡æ–‡ç« ä¸­çš„æŠ€å·§ï¼Œä½ å¯ä»¥ä¸ºå„ç§å„æ ·çš„äº‹æƒ…è®¾ç½®é€šçŸ¥ã€‚ä¾‹å¦‚ï¼Œæœ‰äººä½¿ç”¨ Ruby å’Œ Twilio æ¥è·Ÿè¸ªç²¾é…¿å•¤é…’çš„ä¾›åº”æƒ…å†µã€‚è¦è·å¾—è¿™ç¯‡æ–‡ç« çš„æ‰€æœ‰ä»£ç ï¼Œè¯·æŸ¥çœ‹[çš„è¦ç‚¹](https://gist.github.com/ssaamm/70dfca15dbb85d5e4a011d926097d62a)ã€‚æ‚¨ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»æˆ‘:

å…è´£å£°æ˜:è¯·ç¡®ä¿è®¾ç½®é€šçŸ¥ä¸ä¼šè¿åæ‚¨æ‰€åœ¨å¤§å­¦çš„å­¦ç”Ÿç³»ç»ŸæœåŠ¡æ¡æ¬¾ã€‚æœ‰ç–‘é—®çš„æ—¶å€™ï¼Œé—®é—®çŸ¥é“çš„äººï¼

ğŸ‰æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼

å‡ºäº‹äº†ã€‚è¯·å†è¯•ä¸€æ¬¡ã€‚

